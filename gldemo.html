<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <script src="shadercompiler.js"></script>
</head>
<body>
<h1>Basic Tests: WebGL</h1>
<div id="fps">Loading...</div>

<canvas id="canvas" width=600 height=600></canvas>

<script id="shader-v" type="x-shader/x-vertex">#version 300 es
out vec3 vcolor;
uniform float t;
const vec2 square[4] = vec2[4](
    vec2(0.0,0.0),
    vec2(1.0,0.0),
    vec2(0.0,1.0),
    vec2(1.0,1.0)
);
void main() {
    float s = float(gl_InstanceID)/10000.0;
    mat2 m = mat2(
        sin(s*t)*s, cos(s*t)*s,
        -cos(s*t)*s, sin(s*t)*s
    )*2.0;
    gl_Position = vec4(m*square[gl_VertexID],1.0,1.0);
    
    vcolor = vec3(square[gl_VertexID],0.5);
}
</script>

<script id="shader-f" type="x-shader/x-fragment">#version 300 es
precision highp float;
out vec4 color;
in vec3 vcolor;

void main() {
    color = vec4(vcolor, 1.0);
}
</script>
<script>

function start(canvas,gl) {
    let last_t = null;
    const sc = new ShaderCompiler(gl,
        {'shader':['shader-v','shader-f']},
    );
    for (const e of sc.errors) {
        console.log(e.toString());
    }
    const program = sc.programs.get('shader');
    const uniforms = new Uniforms(sc.uniformProfiles.get('shader'));
    
    // Initial gl setup
    gl.useProgram(program);
    const t_loc = gl.getUniformLocation(program,"t");
    gl.clearColor(0.5, 0.5, 0.5, 1.0);
    gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
    gl.enable(gl.DEPTH_TEST);
    gl.depthFunc(gl.GREATER);
    gl.clearDepth(0.0);
    gl.enable(gl.SCISSOR_TEST);
    gl.scissor(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
    
    let timer = 0;
    let frames = 0;
    (function loop(t) {
        if (last_t !== null) {
            const dt = t-last_t;
            timer += dt;
            frames += 1;
            if (timer > 100) {
                const fps = 1000*frames/timer;
                document.getElementById("fps").textContent = fps.toFixed(3) + " fps";
                frames = 0;
                timer = 0;
            }
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
            gl.uniform1f(t_loc,t*0.01);
            gl.drawArraysInstanced(gl.TRIANGLE_STRIP,0,4,10000);
        }
        last_t = t;
        window.requestAnimationFrame(loop);
    })(null);
}

const canvas = document.getElementById("canvas");
const gl = canvas.getContext("webgl2");

if (gl !== null) {
    start(canvas,gl);
} else {
    console.log("Can't get context.");
}

</script>

</div>
</body>
</html>
